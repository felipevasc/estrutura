generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model Projeto {
  id        Int      @id @default(autoincrement())
  nome      String
  createdAt DateTime @default(now()) @map("criacao")
  updatedAt DateTime @updatedAt @map("atualizacao")

  dominios Dominio[]
  redes    Rede[]
  ips      Ip[]
  commands Command[]
  sentinelas Sentinela[]
  takedowns Takedown[]
  fontesVazamento FonteVazamento[]

  @@map("projetos")
}

model Dominio {
  id       Int     @id @default(autoincrement())
  endereco String
  alias    String?
  captura   String?
  capturadoEm DateTime?
  tipo     TipoDominio @default(principal)

  projetoId Int
  projeto   Projeto @relation(fields: [projetoId], references: [id])

  // Relação de auto-referência para subdomínios
  paiId       Int?
  pai         Dominio?  @relation("SubDominios", fields: [paiId], references: [id])
  subDominios Dominio[] @relation("SubDominios")

  ips Ip[]
  diretorios Diretorio[]
  deface Deface[]
  vazamentos VazamentoInformacao[]
  whatwebResultados WhatwebResultado[]
  informacoes InformacaoDominio[]
  phishing Phishing[]
  termosPhishing TermoPhishing[]
  auxiliaresPhishing AuxiliarPhishing[]
  tldsPhishing TldPhishing[]
  configuracaoPhishingCatcher ConfiguracaoPhishingCatcher?

  @@map("dominios")
}

enum TipoDominio {
  principal
  dns
  mail
}

model Rede {
  id    Int     @id @default(autoincrement())
  cidr  String
  alias String?

  projetoId Int
  projeto   Projeto @relation(fields: [projetoId], references: [id])

  // Relação de auto-referência para sub-redes
  paiId    Int?
  pai      Rede?    @relation("SubRedes", fields: [paiId], references: [id])
  subredes Rede[]   @relation("SubRedes")

  ips Ip[]

  @@map("redes")
}

model Ip {
  id    Int     @id @default(autoincrement())
  endereco  String

  projetoId Int
  projeto   Projeto @relation(fields: [projetoId], references: [id])

  dominios Dominio[]
  redes    Rede[]
  portas   Porta[]
  usuarios Usuario[]
  diretorios Diretorio[]
  whatwebResultados WhatwebResultado[]

  @@map("ips")
}

model Command {
  id              Int           @id @default(autoincrement())
  command         String
  args            String
  executedCommand String?
  projectId       Int
  project         Projeto       @relation(fields: [projectId], references: [id])
  status          CommandStatus @default(PENDING)
  output          String?
  rawOutput       String?
  createdAt       DateTime      @default(now())
  startedAt       DateTime?
  completedAt     DateTime?

  @@map("commands")
}

model Sentinela {
  id              Int             @id @default(autoincrement())
  nome            String
  modulo          SentinelaModulo
  ferramenta      String
  parametros      Json
  cron            String
  habilitado      Boolean         @default(true)
  proximaExecucao DateTime?
  ultimaExecucao  DateTime?
  projetoId       Int
  projeto         Projeto         @relation(fields: [projetoId], references: [id])
  criadoEm        DateTime        @default(now())
  atualizadoEm    DateTime        @updatedAt

  @@map("sentinelas")
}

enum CommandStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
}

enum SentinelaModulo {
  RECON
  CTI
}

model Porta {
  id  Int   @id @default(autoincrement())
  numero  Int
  protocolo String?
  servico String?
  versao  String?
  captura   String?
  capturadoEm DateTime?
  ipId  Int?
  ip    Ip?   @relation(fields: [ipId], references: [id])

  whatwebResultados WhatwebResultado[]

  @@map("portas")
}

model Usuario {
  id   Int    @id @default(autoincrement())
  nome String
  ipId Int
  ip   Ip     @relation(fields: [ipId], references: [id])

  @@map("usuarios")
}

model Diretorio {
  id          Int      @id @default(autoincrement())
  caminho     String
  status      Int?
  tamanho     Int?
  tipo        TipoDiretorio @default(diretorio)
  captura   String?
  capturadoEm DateTime?

  dominioId   Int?
  dominio     Dominio? @relation(fields: [dominioId], references: [id])

  ipId        Int?
  ip          Ip?      @relation(fields: [ipId], references: [id])

  whatwebResultados WhatwebResultado[]

  createdAt   DateTime @default(now())

  @@map("diretorios")
}

model Deface {
  id        Int      @id @default(autoincrement())
  url       String
  fonte     String
  dominioId Int
  dominio   Dominio  @relation(fields: [dominioId], references: [id])
  captura   String?
  capturadoEm DateTime?
  createdAt DateTime @default(now())

  @@map("deface")
}

model VazamentoInformacao {
  id        Int      @id @default(autoincrement())
  url       String
  fonte     String
  titulo    String?
  snippet   String?
  dominioId Int
  dominio   Dominio  @relation(fields: [dominioId], references: [id])
  criadoEm  DateTime @default(now())

  @@map("vazamentos_informacao")
}

model Phishing {
  id        Int      @id @default(autoincrement())
  alvo      String
  termo     String
  fonte     String
  dominioId Int
  dominio   Dominio  @relation(fields: [dominioId], references: [id])
  criadoEm  DateTime @default(now())
  ultimaVerificacao       DateTime?
  statusUltimaVerificacao PhishingVerificacaoStatus?
  captura   String?
  capturadoEm DateTime?
  status   PhishingStatus @default(NECESSARIO_ANALISE)

  @@map("phishing")
}

model TermoPhishing {
  id        Int      @id @default(autoincrement())
  termo     String
  dominioId Int
  dominio   Dominio  @relation(fields: [dominioId], references: [id])
  criadoEm  DateTime @default(now())

  @@unique([termo, dominioId])
  @@map("termos_phishing")
}

model AuxiliarPhishing {
  id        Int      @id @default(autoincrement())
  termo     String
  dominioId Int
  dominio   Dominio  @relation(fields: [dominioId], references: [id])
  criadoEm  DateTime @default(now())

  @@unique([termo, dominioId])
  @@map("auxiliares_phishing")
}

model TldPhishing {
  id        Int      @id @default(autoincrement())
  tld       String
  dominioId Int
  dominio   Dominio  @relation(fields: [dominioId], references: [id])
  criadoEm  DateTime @default(now())

  @@unique([tld, dominioId])
  @@map("tlds_phishing")
}

model ConfiguracaoPhishingCatcher {
  id        Int      @id @default(autoincrement())
  palavras  Json
  tlds      Json
  dominioId Int     @unique
  dominio   Dominio @relation(fields: [dominioId], references: [id])
  criadoEm  DateTime @default(now())
  atualizadoEm DateTime @updatedAt

  @@map("phishing_catcher_configuracoes")
}

model Takedown {
  id                      Int                        @id @default(autoincrement())
  url                     String
  solicitadoEm            DateTime                   @default(now())
  previsao                DateTime
  derrubadoEm             DateTime?
  status                  TakedownStatus             @default(SOLICITADO)
  ultimaVerificacao       DateTime?
  statusUltimaVerificacao TakedownVerificacaoStatus?
  metodoHttp              String                     @default("GET")
  headers                 String?
  body                    String?
  projetoId               Int
  projeto                 Projeto                    @relation(fields: [projetoId], references: [id])
  solicitantes            TakedownSolicitante[]

  @@map("takedowns")
}

model TakedownSolicitante {
  id        Int        @id @default(autoincrement())
  nome      String     @unique
  takedowns Takedown[]

  @@map("takedown_solicitantes")
}

model FonteVazamento {
  id           Int                  @id @default(autoincrement())
  nome         String
  tipo         FonteVazamentoTipo
  parametros   Json
  observacoes  String?
  projetoId    Int?
  projeto      Projeto?             @relation(fields: [projetoId], references: [id])
  buscaAtiva   BuscaAtivaTelegram?
  criadoEm     DateTime             @default(now())
  atualizadoEm DateTime             @updatedAt

  @@map("fontes_vazamento")
}

enum TakedownStatus {
  SOLICITADO
  DERRUBADO
}

enum TakedownVerificacaoStatus {
  ONLINE
  OFFLINE
}

enum PhishingStatus {
  POSSIVEL_PHISHING
  NECESSARIO_ANALISE
  PHISHING_IDENTIFICADO
  FALSO_POSITIVO
  NECESSARIO_REANALISE
}

enum PhishingVerificacaoStatus {
  ONLINE
  OFFLINE
}

enum TipoDiretorio {
  diretorio
  arquivo
}

enum FonteVazamentoTipo {
  TELEGRAM
  FORUM_SURFACE
  FORUM_DARKWEB
}

model BuscaAtivaTelegram {
  id                   Int             @id @default(autoincrement())
  fonteId              Int             @unique
  fonte                FonteVazamento  @relation(fields: [fonteId], references: [id])
  extensoes            Json
  ultimaCapturaSucesso DateTime?
  destinoCentral       String?
  criadoEm             DateTime        @default(now())
  atualizadoEm         DateTime        @updatedAt

  @@map("busca_ativa_telegram")
}

model WhatwebResultado {
  id         Int      @id @default(autoincrement())
  assinatura String   @unique
  plugin     String
  valor      String
  dados      Json?
  dominioId  Int?
  dominio    Dominio? @relation(fields: [dominioId], references: [id])
  ipId       Int?
  ip         Ip?      @relation(fields: [ipId], references: [id])
  diretorioId Int?
  diretorio  Diretorio? @relation(fields: [diretorioId], references: [id])
  portaId    Int?
  porta      Porta?   @relation(fields: [portaId], references: [id])
  criadoEm   DateTime @default(now())

  @@map("whatweb_resultados")
}

model InformacaoDominio {
  id        Int      @id @default(autoincrement())
  campo     String
  valor     String
  dominioId Int
  dominio   Dominio @relation(fields: [dominioId], references: [id])
  criadoEm  DateTime @default(now())
  atualizadoEm DateTime @updatedAt

  @@unique([dominioId, campo])
  @@map("informacoes_dominio")
}
